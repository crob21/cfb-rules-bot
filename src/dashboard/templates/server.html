{% extends "base.html" %}

{% block title %}{{ guild.name }} - Harry Dashboard{% endblock %}

{% block content %}
<a href="/dashboard" class="back-link">
    â† Back to servers
</a>

<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
    <div class="server-icon" style="width: 64px; height: 64px; font-size: 1.75rem;">
        {% if guild.icon_url %}
        <img src="{{ guild.icon_url }}" alt="{{ guild.name }}">
        {% else %}
        {{ guild.name[0] }}
        {% endif %}
    </div>
    <div>
        <h1 class="page-title">{{ guild.name }}</h1>
        <p class="page-subtitle" style="margin-bottom: 0;">Configure Harry's features for this server</p>
    </div>
</div>

<!-- Modules -->
<div class="card">
    <h3 class="card-title">âš™ï¸ Feature Modules</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Enable or disable feature modules for this server
    </p>
    
    <div class="toggle-row">
        <div class="toggle-info">
            <h4>ğŸ¤– Core</h4>
            <p>Harry's personality, general AI chat, bot management</p>
        </div>
        <label class="toggle">
            <input type="checkbox" checked disabled>
            <span class="toggle-slider"></span>
        </label>
    </div>
    
    <div class="toggle-row">
        <div class="toggle-info">
            <h4>ğŸˆ CFB Data</h4>
            <p>Player lookup, rankings, matchups, schedules, draft, transfers, betting</p>
        </div>
        <label class="toggle">
            <input type="checkbox" id="module-cfb_data" 
                   {% if config.modules.cfb_data %}checked{% endif %}
                   onchange="updateModule('cfb_data', this.checked)">
            <span class="toggle-slider"></span>
        </label>
    </div>
    
    <div class="toggle-row">
        <div class="toggle-info">
            <h4>ğŸ† League Features</h4>
            <p>Timer, advance, charter, rules, league staff, dynasty schedule</p>
        </div>
        <label class="toggle">
            <input type="checkbox" id="module-league" 
                   {% if config.modules.league %}checked{% endif %}
                   onchange="updateModule('league', this.checked)">
            <span class="toggle-slider"></span>
        </label>
    </div>
</div>

<!-- Auto Responses -->
<div class="card">
    <h3 class="card-title">ğŸ’¬ Auto Responses</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Control Harry's automatic jump-in responses
    </p>
    
    <div class="toggle-row">
        <div class="toggle-info">
            <h4>ğŸˆ Team Banter</h4>
            <p>Harry jumps in with responses like "Fuck Oregon!" when team names are mentioned</p>
        </div>
        <label class="toggle">
            <input type="checkbox" id="setting-auto_responses" 
                   {% if config.settings.auto_responses is not defined or config.settings.auto_responses %}checked{% endif %}
                   onchange="updateSetting('auto_responses', this.checked)">
            <span class="toggle-slider"></span>
        </label>
    </div>
    
    <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 1rem;">
        ğŸ’¡ Harry's cockney personality and Oregon hatred are always on - this just controls automatic responses.
    </p>
</div>

<!-- Bot Admins -->
<div class="card">
    <h3 class="card-title">ğŸ‘¥ Bot Admins</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Users who can manage Harry's settings (in addition to Discord admins)
    </p>
    
    <div class="admin-list" id="admin-list">
        {% for admin in config.admins %}
        <div class="admin-item" data-id="{{ admin.id }}">
            <div class="admin-info">
                <div class="admin-avatar"></div>
                <span>{{ admin.username }}</span>
            </div>
            <button class="remove-btn" onclick="removeAdmin('{{ admin.id }}')">
                âœ•
            </button>
        </div>
        {% else %}
        <p style="color: var(--text-muted); text-align: center; padding: 1rem;">
            No bot admins configured. Discord server admins can always manage Harry.
        </p>
        {% endfor %}
    </div>
    
    <div class="input-group">
        <input type="text" id="admin-user-id" class="input" placeholder="Discord User ID">
        <input type="text" id="admin-username" class="input" placeholder="Username (optional)">
        <button class="btn btn-primary" onclick="addAdmin()">Add Admin</button>
    </div>
    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">
        To get a user ID: Enable Developer Mode in Discord, right-click user â†’ Copy ID
    </p>
</div>

<!-- Quick Commands Reference -->
<div class="card">
    <h3 class="card-title">ğŸ“‹ Available Commands</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div>
            <h4 style="color: var(--text-secondary); margin-bottom: 0.5rem;">ğŸ¤– Core (Always On)</h4>
            <ul style="color: var(--text-muted); font-size: 0.875rem; list-style: none;">
                <li>/ask - Ask Harry anything</li>
                <li>/help - Get help</li>
                <li>/summarize - Summarize a channel</li>
            </ul>
        </div>
        
        <div id="cfb-commands" style="{% if not config.modules.cfb_data %}opacity: 0.5;{% endif %}">
            <h4 style="color: var(--text-secondary); margin-bottom: 0.5rem;">ğŸˆ CFB Data</h4>
            <ul style="color: var(--text-muted); font-size: 0.875rem; list-style: none;">
                <li>/player - Look up a player</li>
                <li>/players - Bulk player lookup</li>
                <li>/rankings - CFB rankings</li>
                <li>/matchup - Team rivalry history</li>
                <li>/transfers - Transfer portal</li>
            </ul>
        </div>
        
        <div id="league-commands" style="{% if not config.modules.league %}opacity: 0.5;{% endif %}">
            <h4 style="color: var(--text-secondary); margin-bottom: 0.5rem;">ğŸ† League Features</h4>
            <ul style="color: var(--text-muted); font-size: 0.875rem; list-style: none;">
                <li>/advance - Start countdown</li>
                <li>/time_status - Check timer</li>
                <li>/schedule - Dynasty schedule</li>
                <li>/charter - League rules</li>
                <li>/pick_commish - Find co-commish</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const guildId = '{{ guild.id }}';
    
    async function updateSetting(setting, enabled) {
        const result = await apiCall(`/api/server/${guildId}/settings`, 'POST', {
            settings: { [setting]: enabled }
        });
        
        if (result.success) {
            const friendlyName = setting.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            showToast(`${friendlyName} ${enabled ? 'enabled' : 'disabled'}!`);
        } else {
            showToast('Failed to update setting', 'error');
            document.getElementById(`setting-${setting}`).checked = !enabled;
        }
    }
    
    async function updateModule(module, enabled) {
        const result = await apiCall(`/api/server/${guildId}/modules`, 'POST', {
            modules: { [module]: enabled }
        });
        
        if (result.success) {
            showToast(`${module} ${enabled ? 'enabled' : 'disabled'}!`);
            
            // Update command list opacity
            const cmdList = document.getElementById(module === 'cfb_data' ? 'cfb-commands' : 'league-commands');
            if (cmdList) {
                cmdList.style.opacity = enabled ? '1' : '0.5';
            }
        } else {
            showToast('Failed to update setting', 'error');
            // Revert toggle
            document.getElementById(`module-${module}`).checked = !enabled;
        }
    }
    
    async function addAdmin() {
        const userId = document.getElementById('admin-user-id').value.trim();
        const username = document.getElementById('admin-username').value.trim() || 'User';
        
        if (!userId) {
            showToast('Please enter a Discord User ID', 'error');
            return;
        }
        
        const result = await apiCall(`/api/server/${guildId}/admins`, 'POST', {
            user_id: userId,
            username: username
        });
        
        if (result.success) {
            showToast(`Added ${username} as admin!`);
            // Refresh page to show new admin
            location.reload();
        } else {
            showToast(result.error || 'Failed to add admin', 'error');
        }
    }
    
    async function removeAdmin(userId) {
        if (!confirm('Remove this admin?')) return;
        
        const result = await apiCall(`/api/server/${guildId}/admins/${userId}`, 'DELETE');
        
        if (result.success) {
            showToast('Admin removed!');
            document.querySelector(`.admin-item[data-id="${userId}"]`).remove();
        } else {
            showToast('Failed to remove admin', 'error');
        }
    }
</script>
{% endblock %}

